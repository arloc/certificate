# Certificate System Role - API Design proposal


## Parameters

## Examples:


### Minimal to get started - Self-sign certificate:

Issue a certificate for `*.example.com` and place it in the standard directory for the distribution.


```yaml

---
- hosts: webserver

  vars:
    certificate_requests:
      - name: mycert
        common_name: *.example.com

  roles:
    - certificate
```

The directories for each distribution are:

* Debian/Ubuntu:
  * Certificates: `/etc/ssl/localcerts/certs/`
  * Keys: `/etc/ssl/localcerts/private/`

* RHEL/CentOS/Fedora:
  * Certificates: `/etc/pki/tls/certs/`
  * Keys: `/etc/pki/tls/private/`


### Choose where the certificates will be placed

Issue a certificate and key and place them under the directories `/some/path/certs/` and `/some/path/private/` respectively.

```yaml

---
- hosts: webserver
  vars:
    certificate_requests:
      - name: mycert
        common_name: *.example.com
        path: /some/path

  roles:
    - certificate
```

Issue a certificate and key and place them in the specified location.

```yaml

---
- hosts: webserver
  vars:
    certificate_requests:
      - name: mycert
        common_name: *.example.com
        certificate: /another/path/other-cert.crt
        key: /another/path/other-cert.key

  roles:
    - certificate
```

### Certificates with one or more SAN (Subject Alternative Name)

```yaml

---
- hosts: webserver
  vars:
    certificate_requests:
      - name: mycert
        common_name: www.example.com
        alternative_names:
          - sub1.example.com
          - sub2.example.com
          - sub3.example.com

  roles:
    - certificate
```


### Setting common subject options

```yaml

---
- hosts: webserver
  vars:
    certificate_requests:
      - name: mycert
        common_name: www.example.com
        country: US
        state: NY
        locality: New York
        organization: Red Hat
        organizational_unit: platform
        email: admin@example.com
  roles:
    - certificate
```


### Setting the certificate key size

```yaml

---
- hosts: webserver
  vars:
    certificate_requests:
      - name: mycert
        common_name: www.example.com
        key_size: 4096
  roles:
    - certificate
```


### Setting the "Key Usage" and "Extended Key Usage" (EKU)


```yaml

---
- hosts: webserver
  vars:
    certificate_requests:
      - name: mycert
        common_name: www.example.com
        key_usage:
          - digitalSignature
          - nonRepudiation
          - keyEncipherment
        extended_key_usage:
          - 'id-kp-clientAuth'
          - 'id-kp-serverAuth'
  roles:
    - certificate
```


### Don't wait for the certificate to be issued

The certificate issuance can take several minutes depending on the CA.
Because of that it's also possible to request the certificate but not actually
wait for it.

```yaml

---
- hosts: webserver
  vars:
    certificate_requests:
      - name: mycert
        common_name: www.example.com
        wait: false
  roles:
    - certificate
```


### Set a principal

```yaml

---
- hosts: webserver
  vars:
    certificate_requests:
      - name: mycert
        common_name: www.example.com
        principal: HTTP/www.example.com

  roles:
    - certificate
```


### Choosing to not auto-renew a certificate

By default certificates generated by the role will be set for auto-rewal.
To disable that behavior set `auto_renew: no`.

```yaml

---
- hosts: webserver
  vars:
    certificate_requests:
      - name: mycert
        common_name: www.example.com
        auto_renew: no

  roles:
    - certificate
```


### Using FreeIPA to issue a certificate

If your host is enrolled in IPA you will also have the option to use it's
CA to issue your certificate. To do that just set `ca: ipa`.

Note: `ipa` CA is only available when using certmonger as provider.

```yaml

---
- hosts: webserver
  vars:
    certificate_requests:
      - name: mycert
        common_name: www.example.com
        ca: ipa

  roles:
    - certificate
```


### Running a comman before or after a certificate is issued


Sometime is used to execute a command just before a certificate get
renewed and another command just after. In order to do that use `run_before`
and `run_after`.

```yaml

---
- hosts: webserver
  vars:
    certificate_requests:
      - name: mycert
        common_name: www.example.com
        run_before: systemctl stop webserver.service
        run_after: systemctl start webserver.service

  roles:
    - certificate
```

[modeline]: # ( vim: set ts=2 sts=2 et: )
